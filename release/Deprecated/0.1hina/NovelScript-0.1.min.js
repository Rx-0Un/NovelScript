/**
 * NovelScript 0.1 "hina", compressed version
 */

!function(e){var t={};t.setPositionRelative=function(e){e.css("position","relative")},t.setPositionAbsolute=function(e){e.css("position","absolute")},t.getReletiveLeft=function(e){var t=e.parent();return(t.width()-e.width())/2},t.getWindowLeft=function(t){return(e(window).width()-t.width())/2},t.getReletiveTop=function(e){var t=e.parent();return(t.height()-e.height())/2},t.getWindowTop=function(t){return(e(window).height()-t.height())/2},t.horizontal=function(e){t.setPositionRelative(e),e.css("left",t.getReletiveLeft(e))},t.vertical=function(e){t.setPositionRelative(e),e.css("top",t.getReletiveTop(e))},t.fullHorizontal=function(e){t.setPositionAbsolute(e),e.css("left",t.getWindowLeft(e))},t.fullVertical=function(e){t.setPositionAbsolute(e),e.css("top",t.getWindowTop(e))},t.full=function(e){t.setPositionRelative(e),e.css("left",t.getReletiveLeft(e)),e.css("top",t.getReletiveTop(e))},t.fullscreen=function(e){t.setPositionAbsolute(e),e.css("left",t.getWindowLeft(e)),e.css("top",t.getWindowTop(e))},e.fn.extend({align:function(n){return t[n](e(this)),e(this)}})}(jQuery);var NovelScript={},ns=NovelScript;ns.novelScript="hina",ns.version=.1,ns.effect={},ns.dev={},ns.ui={},ns.controls={},ns["default"]={},ns.data={},ns.$frame=$("body"),ns.preloadImage=function(e,t){var n=$.Deferred(),i=e.length;return $(e).each(function(s,o){var r=new Image;r.src=o,r.complete?(t[e[s]]=$(r),i--,console.log(s+1+"/"+e.length),0==i&&n.resolve()):(r.onload=function(s){return function(){t[e[s]]=$(r),i--,console.log(s+1+"/"+e.length),0==i&&n.resolve()}}(s),r.onerror=function(){i--,console.log("failed to load image")})}),n.promise()},ns.preloadAudio=function(e,t){var n=$.Deferred();return n.resolve(),n.promise()},ns.typer=function(){var e={};return e.given=function(e,t,n){e.append(t),(n=n||function(){return 0})()},e.typing=function(e,t,n,i){t=" "+t,n=n||100,i=i||function(){return 0};var s=function(e,t,i){e.append(t.shift()).delay(n).queue(function(){0===t.length?i():s(e,t,i),$(this).dequeue()})};s(e,t.split(""),i)},e.flush=function(e,t,n,i){t=" "+t,n=n||10,i=i||function(){return 0};var s=function(e,t,i){e.append($("<span></span>").html(t.shift()).fadeIn(n)).delay(n).queue(function(){0===t.length?i():s(e,t,i),$(this).dequeue()})};s(e,t.split(""),i)},e}(),ns.store=function(){var e={};return e.infolocal={},localStorage.nsStorageLocal?e.infolocal=JSON.parse(localStorage.nsStorageLocal):localStorage.nsStorageLocal=JSON.stringify(e.infolocal),e.infosession={},sessionStorage.nsStorageSession?e.infosession=JSON.parse(sessionStorage.nsStorageSession):sessionStorage.nsStorageSession=JSON.stringify(e.infosession),e.save=function(){localStorage.nsStorageLocal=JSON.stringify(e.infolocal),sessionStorage.nsStorageSession=JSON.stringify(e.infosession)},e.local=function(t,n){return void 0===n?e.infolocal[t]:(e.infolocal[t]=n,void e.save())},e.session=function(t,n){return void 0===n?e.infosession[t]:(e.infosession[t]=n,void e.save())},e.existLocal=function(t,n){return void 0===e.infolocal[t]&&(e.local(t,n),e.save()),e.infolocal(t)},e.existSession=function(t,n){return void 0===e.infosession[t]&&(e.session(t,n),e.save()),e.session(t)},e.clear=function(t){t=t||"local","local"==t?e.infolocal={}:e.infosession={},e.save()},e}(),ns.init=function(e,t,n){if(ns.$deferred=$.Deferred(),!e)throw"failed to load script data.";ns.data=e,ns.$frame=t||$("body"),ns.dp=ns.initDp(ns.data),ns.importState(ns.getStoredState()),ns.state.state.round||ns.initState(),ns.ui.initTheme({width:ns.$frame.width(),height:ns.$frame.height()}),ns.initControls(n),ns.relation=ns.initRelation(),ns.stage=ns.ui.frame(),ns.stage.$main.appendTo(ns.$frame),ns.slides=ns.slide(),ns.resource=ns.initResource(n)},ns["default"].state={meta:{nsversion:.1,idkey:"Lixia: the intro of summer"},timestamp:"2016-02-14 15:20:00",state:{round:null,script:"id01",position:0},stack:{speaker:null,dialogue:"",cg:[],bg:0,bgm:0}},ns["default"].setting={theme:"hina"},ns["default"].dialogueDisplay=ns.typer.flush,ns.initDp=function(e){var t={};return t.get=function(t,n){return n?e[t][n]:e[t]},t.getFromState=function(){return t.get(ns.state.state.script,ns.state.state.position)},t.stackFix=function(e,n){var i=t.get(e,n);if(0==n)return i;var s=function(e){var t=[];if(e.figure){for(var n=0;n<e.figure.length;n++)if(""==e.figure||0==e.figure){t.push("cg");break}}else t.push("figure");return e.cg||t.push("cg"),e.bg||t.push("bg"),e.bgm||t.push("bgm"),t.length?t:!1},o=s(i);if(!o)return i;for(var r=function(s){for(var o,r=n;r>=0;r--)o=t.get(e,r)[s],o[s]&&0!=o[s]&&(i[s]=o[s])},a=function(){for(var s=[],o=0;n>o;o++){var r=t.get(e,o).figure;if(r)for(var a=0;a<r.length;a++)""!=r[a]&&(s[a]=r[a])}i.figure=s},u=0;u<o.length;u++)"figure"==o[u]?a():r(o[u]);return i},t.resourceCollector=function(e){e=e||ns.data;var t={};t.images=[],t.audios=[];for(var n=Object.keys(e),i=0;i<n.length;i++)for(var s=e[Object.keys[e][i]],o=0;o<s.length;o++){for(var r=0;r<s[o].figure.length;r++){var a=s[o].figure[r];a&&!t.images.indexOf(a)&&t.images.push(a)}var u=s[o].cg;u&&!t.images.indexOf(u)&&t.images.push(u);var c=s[o].bg;c&&!t.images.indexOf(c)&&t.images.push(c);var l=s[o].bgm;l&&!t.audios.indexOf(l)&&t.audios.push(l)}return t},t.firstScript=function(){return e[Object.keys(e)[0]]},t},ns.dp={},ns.initResource=function(e){var t={};return t.images={},t.audios={},t.get=function(t,n){switch(t){case"figure":return $("<img />").attr("src",e.path.figure+n);case"cg":return e.path.cg+n;case"bg":return e.path.bg+n;case"bgm":return $("<audio></audio>").attr("src",e.path.bgm+n);default:throw"No specified type "+t}},t},ns.resource={},ns.resource.images={},ns.resource.audios={},ns.loadResource=function(){var e=$.Deferred(),t=ns.controls.images,n=ns.controls.audios;return $.when(ns.preloadImage(t,ns.resource.images)).done(function(){$.when(ns.preloadAudio(n,ns.resource.audios)).done(function(){e.resolve()}).fail(function(){throw"Audio preloading failed."})}).fail(function(){throw"Images preloading failed"}),e.promise()},ns.start=function(e,t){var n=ns.dp,i=ns.slide();e=e||n.firstScript(),t=t||0,i.move(),i.active()},ns.initRelation=function(){for(var e=ns.controls.relation,t=Object.keys(ns.data),n=0;t-1>n;n++)Object.keys(e).indexOf(t[n])||(e[t[n]]={condition:!0,child:t[n+1]});return e[t[n]]=null,e},ns.relation={},ns.state={},ns.getStoredState=function(e){return ns.store.local("nsstate")},ns.storeState=function(){ns.store.local("nsstate",ns.state)},ns.importState=function(e){ns.state=ns.controls.statePassable(e)||ns["default"].state},ns.initState=function(){ns.state.state.round=0,ns.state.state.script=Object.keys(ns.data)[0],ns.state.stack=ns.data[ns.state.state.script][0],ns.storeState()},ns.dev.statExample={meta:{nsversion:.1,idkey:"Lixia: the intro of summer"},timestamp:"2016-02-14 15:20:00",state:{round:null,script:"id01",position:0},stack:{speaker:null,dialogue:"",cg:[],bg:0,bgm:0}},ns.ui.initTheme=function(e){ns.ui.themes.hina={},function(t){t.mainstageStyle={width:e.width,height:e.height,"background-color":"#f3f3f3","background-size":e.width+"px "+e.height+"px",position:"relative"},t.mainstageStyle["background-image"]="url('tmp/e/koharu.jpg')",t.figureStyle={width:e.width,position:"absolute",bottom:0,"text-align":"center"},t.figureImageStyle={height:.8*e.height},t.contentStyle={width:.7*e.width,height:e.height/4,position:"absolute",bottom:0,"background-image":"url('tmp/e/sf.png')"},t.dialogueStyle={width:"inherit",height:"inherit","background-color":"#87CEEB",opacity:.4};var n=t.contentStyle.width,i=t.contentStyle.height;t.contentStyle.left=(e.width-n)/2,t.dialogueStyle["border-radius"]=n/2+"px/"+i/2+"px",t.speakerStyle={"background-color":"#87CEEB",position:"absolute",left:0,top:0},t.dialStyle={"font-size":"150%",position:"absolute",left:n/8,top:i/5}}(ns.ui.themes.hina)},ns.ui.themes={},ns.ui.frame=function(){var e=(ns.$frame.width(),ns.$frame.height(),{});return e.$main=$("<div></div>").css(ns.controls.theme.mainstageStyle),e.$figure=$("<div></div>").css(ns.controls.theme.figureStyle).appendTo(e.$main),e.$content=$("<div></div>").css(ns.controls.theme.contentStyle).appendTo(e.$main),e.$dialogue=$("<div></div>").css(ns.controls.theme.dialogueStyle).appendTo(e.$content),e.$speaker=$("<h2></h2>").css(ns.controls.theme.speakerStyle).html("武也").appendTo(e.$content),e.$dial=$("<p></p>").css(ns.controls.theme.dialStyle).html("那样就更差劲了吧，<br>一辈子都不要忘了自己惹哭过的少女的模样啊！").appendTo(e.$content),e},ns.stage={},ns.slide=function(){var e={},t=ns.state.stack,n=ns.state.state,i=ns.stage,s=ns.dp,o=ns.relation,r=ns.resource;e.repaint=function(){t.speaker&&e.speaker(),t.bg&&e.bg(),t.cg&&e.cg(),t.figure&&t.figure.length&&e.figure()},e.changeStack=function(e,i){if(!e)throw"No target for slide.jumpScript.";i=i||0,n.script=e,n.position=i,t=ns.dp.stackFix(e,i)},e.jumpScript=function(t,n){e.changeStack(t,n),e.move()},e.next=function(){if(n.position<s.get(n.script).length-1){n.position++;var i=s.get(n.script,n.position);t.speaker=i.speaker,t.dialogue=i.dialogue;var r=["cg","bg","bgm"];if(function(e){for(var n=0;n<e.length;n++)i[e[n]]&&(t[e[n]]=i[e[n]])}(r),i.figure){for(var a=0;a<i.figure.length;a++)""!=i.figure[a]&&(t.figure[a]=i.figure[a]);var u=[];for(a=0;a<t.figure.length;a++)0!==t.figure[a]&&"0"!==t.figure[a]&&u.push(t.figure[a]);t.figure=u.slice()}}else{var c=o[n.script];if(null===c)ns.$deferred.resolve();else for(var l=0;l<c.length;l++)if(c[l].condition)return e.jumpScript(c[l]),!0}},e.speaker=function(){i.$speaker.html(t.speaker)},e.changeBackgroundImage=function(e){i.$main.css("background-image","url("+e+")")},e.bg=function(){0===t.bg||"0"===t.bg?i.$main.css("background-image","none"):e.changeBackgroundImage(r.get("bg",t.bg))},e.cg=function(){0===t.cg||"0"===t.cg?(e.bg(),i.$figure.show()):(i.$figure.hide(),e.changeBackgroundImage(r.get("cg",t.cg)))},e.figures=[],e.figure=function(){e.figures=[],i.$figure.html("");for(var n=0;n<t.figure.length-1;n++)e.figures.push(r.get("figure",t.figure[n]));for(e.figures.push(r.get("figure",t.figure[n])),n=0;n<e.figures.length;n++)e.figures[n].css(ns.controls.theme.figureImageStyle).appendTo(i.$figure)};var a=t.dialogue;e.move=function(){a=t.dialogue;var n=ns.typer.flush;i.$dial.html(""),i.$main.unbind("click").bind("click",u),e.repaint(),n(i.$dial,a,20,function(){i.$main.unbind("click").bind("click",e.move)}),e.next()};var u=function(){i.$dial.finish().html(a),i.$main.unbind("click").bind("click",e.move)};return e.active=function(){i.$main.bind("click",e.move)},e},ns.slides={};
